let gData,gRegions=[],gThresholds={carriers:0,discharged:0,deaths:0,pcrtested:0};const LANG=$("html").attr("lang"),COLORS={default:"#3DC",second:"#6DF",third:"#FEA",deaths:"#EB8",serious:"#FEA",pcrtests:"#6F6587,#5987A5,#3BA9B0,#48C7A6,#86E18D,#D5F474".split(","),dark:"#399",selected:"#EC2"},LABELS={ja:{change:"前日比",total:"合計",transition:{carriers:["有症状","無症状","確認中"],cases:["患者数"],discharged:["確認済み","確認中"],deaths:["確認済み","確認中"],pcrtested:["PCR検査人数"],pcrtests:["国立感染症研究所","検疫所","地方衛生研究所・保健所","民間検査会社","大学等","医療機関"],serious:["重症者数"]},unit:{carriers:"名",cases:"名",discharged:"名",pcrtested:"名",serious:"名",deaths:"名",pcrtests:"名"},demography:{deaths:"死亡",serious:"重症",misc:"軽症・無症状・確認中"},age:["80代以上","70代","60代","50代","40代","30代","20代","10代","10歳未満","不明"]},en:{change:"Daily: ",total:"Total",transition:{carriers:["With Symptoms","No Symptom","Checking"],cases:["Active Cases"],discharged:["MHLW Confirmed","Confirming"],deaths:["MHLW Confirmed","Confirming"],pcrtested:["PCR Tested"],serious:["Serious"],pcrtests:["National Institute of Infectious Diseases","Quarantine Stations","Public Health Institute, Public Health Center","Private Testing Companies","Universities","Medical Institutions"]},unit:{carriers:"",cases:"",discharged:"",pcrtested:"",serious:"",deaths:"",pcrtests:""},demography:{deaths:"Deaths",serious:"Serious",misc:"Mild, No symptom, Checking"},age:["80s+","70s","60s","50s","40s","30s","20s","10s","Under 10","Unknown"]}},init=()=>{const t=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),a=(a,e,s)=>{"-"!==(s=t(s).toString()).charAt(0)&&(s="+"+s);let o=a.find(".latest");o.find(".value").text(t(e)),o.find(".unit").text(LABELS[LANG].unit[a.attr("code")]),o.find(".type").text((t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase())(a.find(".switch[value=total]").text())),o.find(".change").text(LABELS[LANG].change+" "+s)},e=(t,a)=>{let e=t.find("h5.updated");if(!e.hasClass("show")){let t=a.data.labels[a.data.labels.length-1],s={ja:t.replace("/","月")+"日時点",en:"As of "+t};e.text(s[LANG]),e.addClass("show")}},s=(a,e,s)=>{let o=a.find(".axis-chart").empty().html("<canvas></canvas>").find("canvas")[0],n={type:"bar",data:e,options:{maintainAspectRatio:!1,legend:{display:!1},title:{display:!1},scales:{xAxes:[{stacked:s,drawBorder:!1,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.0)",maxRotation:0,minRotation:0}}],yAxes:[{id:"axisScale",location:"bottom",stacked:s,gridLines:{drawBorder:!1,display:!1},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,e,s){if(Math.floor(a)===a)return t(a.toString())}}}]}}};n.data.datasets.forEach(function(t,a){t.backgroundColor="transparent",t.borderColor="transparent"}),n.data.labels.forEach(function(t,a){;""}),window.myChart=new Chart(o.getContext("2d"),n);let r=window.myChart.scales.axisScale.max,i=window.myChart.scales.axisScale.min,l=0;switch(Math.max(r.toString().length,i.toString().length)){case 1:l=22;break;case 2:l=26;break;case 3:l=34;break;case 4:l=40;break;case 5:l=52;break;case 6:l=58;break;case 7:l=64}a.find(".axis-cover").width(l.toString()+"px")},o=(o,n,i=null)=>{let l=o.find(".main-chart").empty().html("<canvas></canvas>"),d=l.find("canvas")[0],c=o.find(".switch.selected").attr("value"),h=!!o.find(".checkbox.moving-average").hasClass("on"),p=gData.transition[n],u=0,f=0;for(let t=3;t<p[0].length;t++)u+=p[p.length-1][t],f+=p[p.length-2][t];a(o,u,u-f);let g={type:"bar",data:{labels:[],datasets:[]},options:{maintainAspectRatio:!1,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(t){let a=t[0].xLabel.trim()+" 12:00";"ja"===LANG&&(a+="時点"),"en"===LANG&&(a="As of "+a);return a+" "+o.find(".switch.selected").text()},label:function(a,e){let s=[],o=0;e.datasets.forEach(function(e,r){(!h||r>=1)&&(s.push(e.label+": "+t(e.data[a.index])+" "+LABELS[LANG].unit[n]),o+=e.data[a.index])});let r=h?3:2;return e.datasets.length>=r&&s.push(LABELS[LANG].total+": "+t(o)+" "+LABELS[LANG].unit[n]),s}}},scales:{xAxes:[{stacked:!0,gridLines:{display:!1,zeroLineColor:"rgba(255,255,0,0.7)"},ticks:{fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{location:"bottom",stacked:!0,gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.7)",borderDash:[3,1],color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:!0,fontColor:"transparent"}}]},layout:{padding:{left:10}}}};"function"==typeof i&&i(g);for(let t=3;t<p[0].length;t++)g.data.datasets.push({label:LABELS[LANG].transition[n][t-3],backgroundColor:[],data:[]});let b="";if(p.forEach(function(t,a){let e=r(n,t,a);g.data.labels.push(t[1]+"/"+t[2]);for(let s=3;s<p[0].length;s++){let o=t[s];"new"===c&&(o=0,b===e&&""!==t[s]&&""!==p[a-1][s]&&(o=t[s]-p[a-1][s])),g.data.datasets[s-3].data.push(o),g.data.datasets[s-3].backgroundColor.push(r(n,t,s-3))}b=e}),l.width(Math.max(8*g.data.labels.length,l.width())),h){let t={type:"line",label:LABELS[LANG].movingAverage,fill:!1,borderColor:"#EDA",borderWidth:3,pointRadius:0,data:[]};for(let a=0;a<g.data.datasets[0].data.length;a++){let e=null;if(a>=7){e=0;for(let t=0;t<7;t++)g.data.datasets.forEach(function(s,o){e+=parseInt(s.data[a-t])});e/=7}t.data.push(e)}g.data.datasets.unshift(t)}e(o,g),s(o,$.extend(!0,{},g.data),!0),window.myChart=new Chart(d.getContext("2d"),g)},n=t=>{let a=t.find(".main-chart-wrapper");a.animate({scrollLeft:a.width()},0)},r=(t,a,e)=>{let s=COLORS.default,o=1e4*parseInt(a[0])+100*parseInt(a[1])+parseInt(a[2]);return"deaths"===t&&o>=20200413&&(s=COLORS.second),"discharged"===t&&o>=20200420&&(s=COLORS.second),"pcrtested"===t&&o>=20200303&&(s=COLORS.second),o>=20200508&&(s=COLORS.third),"pcrtests"===t&&(s=COLORS.pcrtests[e]),s},i=t=>{let a=$("#select-pref-type").val(),e="rgba(90, 90, 90, 0.6)",s=gData["prefectures-data"][a][gData["prefectures-data"][a].length-1][parseInt(t)+2];return s>=1&&(e=COLORS.dark,0===gThresholds[a]&&(e=COLORS.default)),s>=gThresholds[a]&&gThresholds[a]>=1&&(e=COLORS.default),e},l=()=>{$("#japan-map").empty();const t=$("#japan-map").width();let a=[];gData["prefectures-map"].forEach(function(t,e){a.push({code:t.code,jp:t.ja,en:t.en,color:i(t.code),hoverColor:COLORS.selected,prefectures:[t.code]})}),$("#japan-map").japanMap({areas:a,selection:"prefecture",width:t,borderLineColor:"#242a3c",borderLineWidth:.25,lineColor:"#ccc",lineWidth:1,drawsBoxLine:!1,showsPrefectureName:!1,movesIslands:!0,onHover:function(t){d(t.code),c(t.code)}})},d=a=>{let e=$("#region-chart").empty().html("<canvas></canvas>"),s=e.find("canvas")[0],o=$("#select-pref-type").val(),n={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.4,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){return gData["prefectures-map"].forEach(function(a,e){a.ja!==t[0].yLabel&&a.en!==t[0].yLabel||$("#select-prefecture").val()!==a.code&&c(a.code)}),t[0].yLabel},label:function(t,a){return t.xLabel+{ja:" 名",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,e,s){return t(a)}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};e.outerWidth()>=400&&(n.options.aspectRatio=.5),""!==a&&(n.options.animation.duration=0);let r=[];gData["prefectures-data"][o][gData["prefectures-data"][o].length-1].forEach(function(t,a){a>=3&&r.push({name:gData["prefectures-map"][a-3][LANG],value:t,code:(a-2).toString()})}),r.sort((t,a)=>t.value<a.value?1:t.value>a.value?-1:0),r.forEach(function(t,e){n.data.labels.push(t.name),n.data.datasets[0].data.push(t.value),a==t.code?n.data.datasets[0].backgroundColor.push(COLORS.selected):n.data.datasets[0].backgroundColor.push(i(t.code))});let l=s.getContext("2d");window.myChart=new Chart(l,n)},c=t=>{$("#select-prefecture").val(t),$(".prefecture-chart").each(function(){let a=$(this).attr("code");h(t,a),n($(this))})},h=(o,n)=>{let r=$(".prefecture-chart[code="+n+"]");r.find("h3").find("span").text(gData["prefectures-map"][parseInt(o)-1][LANG]);let i=r.find(".main-chart").empty().html("<canvas></canvas>"),l=i.find("canvas")[0],d=r.find(".switch.selected").attr("value"),c=gData["prefectures-data"][n],h=c[c.length-1][parseInt(o)+2],p=h-c[c.length-2][parseInt(o)+2];a(r,h,p);let u={type:"line",data:{labels:[],datasets:[]},options:{maintainAspectRatio:!1,animation:{duration:0},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,mode:"x",displayColors:!1,callbacks:{title:function(t){if(0===t[0].datasetIndex)return r.find("h3").text()},label:function(t,a){if(0===t.datasetIndex){return t.xLabel.trim()+": "+t.yLabel+{ja:" 名",en:" cases"}[LANG]}}}},scales:{xAxes:[{position:"bottom",gridLines:{display:!1},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{gridLines:{borderDash:[3,1],color:"rgba(255,255,255,0.2)"},ticks:{fontColor:"transparent",zeroLineColor:"rgba(255,255,255,0.7)",callback:function(a,e,s){if(Math.floor(a)===a)return t(a.toString())}}}]},layout:{padding:{left:10}}}};u.data.datasets.push({fill:!1,lineTension:.1,borderColor:COLORS.selected,borderWidth:3,pointRadius:2,pointBorderWidth:1,pointBackgroundColor:"#242a3c",data:[]});for(let t=1;t<=46;t++)u.data.datasets.push({fill:!1,lineTension:.1,borderColor:"#267",borderWidth:1,pointRadius:0,data:[]});c.forEach(function(t,a){if("total"===d){u.data.labels.push(t[1]+"/"+t[2]),u.data.datasets[0].data.push(t[parseInt(o)+2]);for(let a=1;a<=46;a++){let e=a>=parseInt(o)?a+1:a;u.data.datasets[a].data.push(t[e+2])}}else if(a>=1){u.data.labels.push(t[1]+"/"+t[2]);let e=c[a-1][parseInt(o)+2];u.data.datasets[0].data.push(t[parseInt(o)+2]-e);for(let e=1;e<=46;e++){let s=e>=parseInt(o)?e+1:e,n=c[a-1][s+2];u.data.datasets[e].data.push(t[s+2]-n)}}}),i.width(Math.max(10*u.data.labels.length,i.width())),e(r,u),s(r,$.extend(!0,{},u.data),!1),window.myChart=new Chart(l.getContext("2d"),u)};$.getJSON("data/data.json",function(a){gData=a,(()=>{const t=t=>{let a=t.sort((t,a)=>t-a),e=[Math.floor(t.length/2),Math.ceil(t.length/2)];return(a[e[0]]+a[e[1]])/2};for(thType in gThresholds){let a=[],e=gData["prefectures-data"][thType],s=e[e.length-1];for(let t=3;t<s.length;t++)a.push(s[t]);gThresholds[thType]=t(a)}})(),$(".transition").each(function(){let t=$(this).attr("code");o($(this),t),n($(this))}),(()=>{$wrapper=$("#demography-chart").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let a={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.misc,backgroundColor:COLORS.default,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){let a=t[0].yLabel,e=0;return t.forEach(function(t,a){e+=t.xLabel}),a+": "+e+" "+{ja:"名",en:"cases"}[LANG]},label:function(t,a){return a.datasets[t.datasetIndex].label+": "+t.value+{ja:"名",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,e,s){return t(a)}}}],yAxes:[{stacked:!0,barPercentage:.8,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(a.options.aspectRatio=1.1),$wrapper.outerWidth()>=600&&(a.options.aspectRatio=1.3),gData.demography.forEach(function(t,e){a.data.labels.push(LABELS[LANG].age[e]);for(let e=0;e<3;e++)a.data.datasets[e].data.push(t[e])});let e=$canvas.getContext("2d");window.myChart=new Chart(e,a)})(),l(),d(""),c("13"),$(".updated-last").text(gData.updated.last[LANG]),$("#cover-block").fadeOut()}),$(".transition").find(".switch").on("click",function(){let t=$(this).closest(".transition");$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),o(t,t.attr("code"))}),$(".prefecture-chart").find(".switch").on("click",function(){let t=$(this).closest(".prefecture-chart");$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),h($("#select-prefecture").val(),t.attr("code"))}),$("#select-prefecture").on("change",function(){let t=$(this).val();c(t)}),$("#select-pref-type").on("change",function(){l(),d("")}),$(".more").on("click",function(){$(this).closest("p.notes").addClass("show")}),$(".checkboxes").find(".checkbox").on("click",function(){$(this).hasClass("on")?$(this).removeClass("on"):$(this).addClass("on");let t=$(this).closest(".transition");o(t,t.attr("code"),t=>{t.options.animation={duration:0}})}),$('a[href^="#"]').click(function(){let t=$(this).attr("href"),a=$(t).offset().top;return $("body,html").animate({scrollTop:a},400,"swing"),!1})};$(function(){init()});